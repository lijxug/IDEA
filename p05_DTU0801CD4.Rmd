---
title: "AS in LUNG TIL: DTU analysis"
author: "Jason Li"
date: "`r Sys.Date()`"
# output:
#   html_notebook:
#     fig_caption: yes
#     toc: yes
#   html_document:
#     df_print: paged
#     toc: yes
---
```{r, echo=FALSE}
# !diagnostics off
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  error = FALSE
)
```

# Preface 
DTU analysis
```{r input}
suppressWarnings(library("optparse"))

parser <- OptionParser()
option_list <- list( 
  make_option(c("-v", "--verbose"), action="store_true", default=TRUE,
              help="Print extra output [default]"),
  make_option(c("-q", "--quietly"), action="store_false", 
              dest="verbose", help="Print little output"),
  make_option(c("-p", "--parallel_cores"), type = "integer", dest = "cores", default = 6,
              help="Number of cores used in parallel calculation, [default = %default]")
)

# wd = getwd()
inputs = commandArgs(trailingOnly=FALSE)
script_dir = dirname(sub("--file=", "", inputs[grep("--file=",inputs)]))
if(!length(script_dir)){
  script_dir = getwd()
}
# print(script_dir)
source(paste0(script_dir, "/../00.ref_tools/ToolKit.R"))
source(paste0(script_dir, "/../00.ref_tools/utils.R"))

# get real args
parser = OptionParser(
  usage =
    "%prog [options] <BUNDLE.RDa> <scLUNGObj> <OUTPUT_DIR>
  Description:
  This script is used to identify differential usage of transcripts of a genes and try to recognize switch events, 
  It needs gene-based summation of transcripts tpm to filter out the 'low expressed' genes.
  It's a preparation step for calculation of FISHER exact tests.
  This script is powerup by parallel::parApply, make sure the environment supports them first.",
  option_list = option_list
) # donot change the format of this doc.

itfs = parse_args(parser, positional_arguments = TRUE) 

itfs = parse_args(parser, positional_arguments = TRUE, args = c(
  "-p", 6,
  # WhereAmI("01.DATA/01.ASinLung/02.ready/stringtie/p04.annalyse_bundle.RDa"),
  WhereAmI("01.DATA/01.ASinLung/02.ready/stringtie_removeHaplotypes/p01.scLUNGsceset.RDS"),
  WhereAmI("01.DATA/01.ASinLung/06.function_annotation/preferentially_used_transcripts/")
))

opts = itfs$options
args = list(
  obj_file = itfs$args[1],
  out_dir = itfs$args[2]
)

# if none arguments input
if(anyNA(args)){
  warning("Missing arguments!")
  parse_args(parser, args = c("--help"))
  q("no", status = 2)
}

```


```{r loading}
# ---- loading dependencies ----
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("reshape2"))
suppressPackageStartupMessages(library("parallel"))
suppressPackageStartupMessages(library("assertthat"))
# suppressPackageStartupMessages(library("multidplyr"))
suppressPackageStartupMessages(library("UpSetR"))
suppressPackageStartupMessages(library("openxlsx"))
# suppressPackageStartupMessages(library("scater"))
theme_set(theme_classic(base_size = 18))


# load data ----
tic = Sys.time()
sceObj = read_rds(args$obj_file) # should be a RDa bundle
# load(args$in_file)

# reduce to only CD4 cells for easier calculation
chn_clusters = (sceObj$characteristics..majorCluster %>% unique() %>% grep(pattern = "CD4", value = T))[1:9]
chn_cells = sceObj$characteristics..majorCluster %in% chn_clusters
sceObj = sceObj[, chn_cells]

# remove txs not in the normal annotation
GENE.INFO = read_tsv(WhereAmI("01.DATA/01.ASinLung/01.raw/GRCh38.p12.biomart.transcripts.txt"))
GENE.INFO = GENE.INFO %>% dplyr::filter(`Chromosome/scaffold name` %in% c(as.character(1:22), "X", "Y", "MT"))

keep_tx = rownames(sceObj) %in% GENE.INFO$`Transcript name`
loginfo("Filter out txs on alternative haplotypes: ", sum(keep_tx), "/", length(keep_tx), " remained.")

sceObj = sceObj[keep_tx, ]

# loading Trajectory & clonal information ----
clonal_tbl = openxlsx::read.xlsx(WhereAmI("01.DATA/01.ASinLung/04.tables/LungTILinfos/LungTIL_Supplementary Table 2.xlsx")) %>% as_tibble()
CD4_trajectory_coord = read_tsv(WhereAmI("01.DATA/01.ASinLung/02.ready/trajectory/CD4Tcell.traj.coor.txt"))


rm(list = grep(ls(), pattern = "^chn_", value = T))
invisible(gc())

```

```{r all expression distribution}
pCells = as_tibble(colData(sceObj))
exprMat_all = assay(sceObj,"tpm")
exprMat_sum = rowsum(exprMat_all, group = rownames(exprMat_all) %>% trans2gene())
exprMat_sum_tbl = exprMat_sum %>% melt(varnames = c("Gene_name", "Cell_id"), value.name = "tpm") %>% dplyr::mutate(cluster = pCells$characteristics..majorCluster[match(Cell_id, pCells$title)])

t_idx = sample(1:nrow(exprMat_all), round(0.2 * nrow(exprMat_all), digits = 0))
t_cell_idx = sample(1:ncol(exprMat_all), round(0.2 * ncol(exprMat_all), digits = 0))
t_exprMat_tbl = log10(exprMat_all[t_idx, t_cell_idx] + 1) %>% melt(varnames = c("id", "cell_id"), value.name = "log10tpm") %>% as_tibble() %>% dplyr::mutate(cluster = pCells$characteristics..majorCluster[match(cell_id, pCells$title)]) %>% as_tibble()

require(ggridges)

usageMat = assay(sceObj, "usage")
t_idx = sample(1:nrow(usageMat), round(0.2 * nrow(usageMat), digits = 0))
t_cell_idx = sample(1:ncol(usageMat), round(0.2 * ncol(usageMat), digits = 0))
t_usageMat_tbl = usageMat[t_idx, t_cell_idx] %>% melt(varnames = c("id", "cell_id"), value.name = "usage") %>% as_tibble() %>% dplyr::mutate(cluster = pCells$characteristics..majorCluster[match(cell_id, pCells$title)]) %>% as_tibble()

require(ggridges)
ggplot(t_exprMat_tbl %>% dplyr::filter(log10tpm > 0)) + 
  ggridges::geom_density_ridges2(aes(x = log10tpm, y = cluster, fill = cluster))+
  geom_vline(xintercept = 1, linetype = 2) +
  theme(legend.position = "bottom")
ggplot(t_usageMat_tbl %>% dplyr::filter(usage > 0)) + 
  ggridges::geom_density_ridges2(aes(x = usage, y = cluster, fill = cluster))+
  scale_x_continuous(breaks = c(0,0.25,0.5,0.75,1)) +
  labs(y = "Cell density")

rm(list = grep(ls(), pattern = "^t_", value = T))
invisible(gc())
```

```{r data preparation}
# genes with more than 1 annotation ----
genes_anntx_counts = GENE.INFO %>% group_by(`Gene name`) %>% summarise(ann_count = length(unique(`Transcript name`)))
genes_morethan1ann = (genes_anntx_counts %>% dplyr::filter(ann_count > 1))$`Gene name`
genes_morethan1ann = intersect(genes_morethan1ann, rownames(exprMat_sum))

# loading ----
usageMat = assay(sceObj, "usage")
sceObj = sceObj[, !is.na(usageMat[1, ])]
pGenes = as_tibble(rowData(sceObj))
pCells = as_tibble(colData(sceObj))

# extract usages and tpms ----
usageMat = assay(sceObj, "usage")
exprMat = assay(sceObj,"tpm")


# remove transcripts with only one txs annotate ----
keep_tx = (rownames(usageMat) %>% trans2gene()) %in% genes_morethan1ann
usageMat = usageMat[keep_tx, ]
exprMat = exprMat[keep_tx, ]

# remove transcripts with only one txs remained ----
genes_morethan1remain = rownames(usageMat) %>% trans2gene() %>% table()
genes_morethan1remain = names(genes_morethan1remain[genes_morethan1remain>1])
keep_tx = (rownames(usageMat) %>% trans2gene()) %in% genes_morethan1ann
usageMat = usageMat[keep_tx, ]
exprMat = exprMat[keep_tx, ]


# cleanup ----
loginfo(length(genes_morethan1ann), "/", nrow(exprMat_sum), " genes with more than 1 annotations")
loginfo(length(genes_morethan1remain), "/", nrow(exprMat_sum), " genes with more than 1 remian")

loginfo("Filter out isoforms: ", nrow(usageMat), "/", nrow(pGenes))

rm(sceObj, keep_tx)
invisible(gc())
```

```{r load trajectory}
# CD4_trajectory_tbl = bind_cols(CD4_trajectory_coord, MajorType = pCells$characteristics..majorCluster[match(CD4_trajectory_coord$Cell, pCells$title)])
CD4_trajectory_tbl = bind_cols(CD4_trajectory_coord, MajorType = pCells$characteristics..majorCluster[match(CD4_trajectory_coord$Cell, pCells$title)])
ggplot(CD4_trajectory_tbl, aes (x = Component1, y = Component2, color = MajorType)) +
  geom_point()

```

Nothing's change after gene expression filter, I should not use it

```{r functions definition}
# function from p03.counts2fisher.R
counts2FISHER_p = function(countMat, alternative = "greater"){
  sum_trans = apply(countMat, 1, sum)
  sum_cat = apply(countMat, 2, sum)
  sum_all = sum(countMat)
  
  minor_trans = sum_trans - countMat
  minor_cat = t(apply(countMat, 1, function(x) sum_cat - x))
  minor_all = sum_all + countMat - matrix(rep(sum_cat, nrow(countMat)), nrow = nrow(countMat), byrow = T)  - matrix(rep(sum_trans, ncol(countMat)), ncol = ncol(countMat))
  
  fisher_res = countMat
  for(i in 1:nrow(countMat)){
    for(j in 1:ncol(countMat)){
      fisherMat = matrix(c(
        countMat[i,j], minor_trans[i,j],
        minor_cat[i,j], minor_all[i,j]
      ), 2,2)
      fisher_res[i,j] = (fisher.test(fisherMat, alternative = alternative))$p.value
    }
  }
  return(fisher_res)
}

usage_cutoff = 0.75
transcript_express_cutoff = 10
local_calculate_fishers = function(gene_name, expression_matrix, usage_matrix, cell_info){
# cutoffs according to p02.usage2labelcounts.R
  # 
  cell_ttlcounts_per_cluster = table(cell_info$characteristics..majorCluster)
  # get txs names
  chn_txs = rownames(usage_matrix) %>% grep(pattern = paste0("^", gene_name, "-\\d+"), value = T)
  if(length(chn_txs) > 1) {
    chn_usage_matrix = usage_matrix[chn_txs,]
    chn_expression_matrix = expression_matrix[chn_txs, ] 
  } else {
    chn_usage_matrix = usage_matrix[chn_txs, ] %>% as.matrix() %>% t()
    rownames(chn_usage_matrix) = chn_txs
    chn_expression_matrix = expression_matrix[chn_txs, ] %>% as.matrix() %>% t()
    rownames(chn_expression_matrix) = chn_txs
  }
  
  chn_expressedMat = chn_expression_matrix > transcript_express_cutoff
  chn_usage_matrix[!chn_expressedMat] = 0
  groups = cell_info$characteristics..majorCluster[match(colnames(chn_usage_matrix), cell_info$title)]
  cell_tags = apply((chn_usage_matrix > usage_cutoff), 2, function(x){
    tx = chn_txs[x]
    if(length(tx) == 0) 
      return("") 
    else 
      return(tx)
    })
  
  chn_countsMat = ((chn_usage_matrix > usage_cutoff) / 1) %>% t() %>% rowsum(., group = groups) %>% t()
  no_express_cells = apply(!chn_expressedMat, 2, all)
  assert_that(all(cell_tags[no_express_cells] == ""))
  cell_tags[no_express_cells] = paste0(gene_name, "-NO_EXPR")
  
  no_expr_row = no_express_cells %>% tapply(., INDEX = groups, sum)
  chn_countsMat = rbind(chn_countsMat, no_expr_row)
  rownames(chn_countsMat)[nrow(chn_countsMat)] = paste0(gene_name, "-NO_EXPR")
  # mix_row = apply((chn_usage_matrix <= usage_cutoff) , 2, all) %>% tapply(., INDEX = groups, sum) - no_expr_row
  mix_row = cell_ttlcounts_per_cluster - base::colSums(chn_countsMat)
  chn_countsMat = rbind(chn_countsMat, mix_row)
  rownames(chn_countsMat)[nrow(chn_countsMat)] = paste0(gene_name, "-MIX")
  
  # calculate fisher matrix
  chn_fishers = -log10(counts2FISHER_p(chn_countsMat) %>% p.adjust.matrix()) %>% round(digits = 2)
  
  # identify mix type
  mix_noexprcells = apply((chn_usage_matrix <= usage_cutoff) , 2, all)
  mix_cells = mix_noexprcells & (!no_express_cells)
  if(nrow(chn_usage_matrix) > 1 ){
    mix_usage_matrix = chn_usage_matrix[, mix_cells]
  } else{
    mix_usage_matrix = chn_usage_matrix[, mix_cells] %>% as.matrix() %>% t()
  }
  invisible(assert_that(all(chn_txs == rownames(mix_usage_matrix))))
  
  if(sum(mix_cells) > 1){
    mix_types = apply(mix_usage_matrix, 2, function(x){
    # take first two txs as mix type
      first_two = x %>% sort(decreasing = T) %>% head(2) %>% names() %>% sort() %>% paste0(collapse = "|")
      return(paste0(gene_name, "-MIX:", first_two))
    }) 
  } else if(sum(mix_cells) == 1){ 
    first_two = mix_usage_matrix %>% sort(decreasing = T) %>% head(2) %>% names() %>% sort() %>% paste0(collapse = "|")
    mix_types = paste0(gene_name, "-MIX:", first_two)
  } else { # 0
    mix_types = NULL
  }
  
  cell_tags[names(mix_types)] = mix_types
  
  return(list(count = chn_countsMat, fisher.p.adj = chn_fishers, cell_tags = cell_tags))
}

p.adjust.matrix = function(p, ...){
  stopifnot(is.matrix(p))
  p.adjs = p.adjust(p, ...)
  p.adj.matrix = matrix(
    p.adjs, 
    ncol = ncol(p),
    dimnames = dimnames(p)
    )
  return(p.adj.matrix)
}

```

### Enrichment calculation
I would like to annotate enrichment scores for every clusters to determine the enriched transcripts in each cluster.
```{r calculate all enrichment infos}
chosen_genes = exprMat %>% rownames() %>% trans2gene() %>% unique()

step = 100
steps = c(seq(1, length(chosen_genes), by = step), length(chosen_genes)+1)
iter01 = ".I1"
initiatePB(iter01)
all_obj_lst = list()
for(i in 2:length(steps)){
# for(i in 1:length(chosen_genes)){
  t_chosen_genes = chosen_genes[steps[i-1]: (steps[i] -1)]
  obj_lst = mclapply(t_chosen_genes, mc.cores = opts$cores, FUN = function(chosen_gene){
  # chosen_gene = chosen_genes[i]
  obj = local_calculate_fishers(gene_name = chosen_gene, expression_matrix = exprMat, usage_matrix = usageMat, cell_info = pCells)
    return(obj)
  })
  names(obj_lst) = t_chosen_genes
  all_obj_lst = c(all_obj_lst, obj_lst)
  
  processBar(iter01, i, length(steps), tail = "ETA")
}
# names(all_obj_lst) = chosen_genes

# identify txs with ???
canonical_txs = mclapply(
  all_obj_lst, mc.cores = opts$cores, 
  function(x){ 
    (x$count %>% apply(1, sum) %>% sort(decreasing = T) %>% names())[1] 
    }) %>% unlist()
canonical_txs = canonical_txs[grep(canonical_txs, pattern = "NO_EXPR|MIX", invert = T)]

enrichment_tbl = do.call(rbind, mclapply(all_obj_lst, mc.cores = opts$cores, function(x){
  return(x$fisher.p.adj %>% melt(value.name = "enrich_score", varnames = c("id", "cluster")) %>% as_tibble(stringsAsFactors = F) %>% dplyr::filter(enrich_score > -log10(0.05)) %>% mutate_if(is.factor, as.character))
}))
enrichment_tbl = enrichment_tbl %>% dplyr::mutate(gene_name = trans2gene(id)) %>% dplyr::distinct() %>% 
  dplyr::filter(!grepl(id, pattern = "NO_EXPR"))
rm(list = grep(ls(), pattern = "^t_", value = T))
```

```{r plot tile, fig.height=8, fig.width=8}
# heatmap for counting
plt_tbl_enrichemnts = enrichment_tbl %>% group_by(gene_name, id, cluster) %>% dplyr::summarise(counts = n()) %>%
  group_by(gene_name) %>% summarise(id_count = length(unique(id)), 
                                    cluster_count = length(unique(cluster))) %>% 
  dplyr::mutate(id_count_cat = ifelse(id_count <= 6, as.character(id_count), ">6")) %>% 
  group_by(cluster_count, id_count_cat) %>% summarise(counts = n())
plt_tbl_enrichemnts$cluster_count = as.factor(plt_tbl_enrichemnts$cluster_count)

p_htmp = ggplot(data = plt_tbl_enrichemnts, aes(x = cluster_count, y = id_count_cat)) + 
  geom_tile(aes(fill = log10(counts))) +
  geom_text(aes(label = counts)) +
  scale_fill_gradient(low = "white", high = "#56B1F7") +
  labs(x = "# of clusters that genes are enriched in", y = "# of expression type enriched", fill = "Log10(gene count)") +
  theme(axis.line = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "bottom")

p_top_clusters = plt_tbl_enrichemnts %>% group_by(cluster_count) %>% summarise(sum_count = sum(counts)) %>% 
  ggplot(aes(x = cluster_count, y = sum_count)) +
  geom_col(aes(fill = cluster_count), color = "black") +
  geom_text(aes(y = sum_count, label = sum_count), vjust = -.5, size = 4) +
  coord_cartesian(ylim = c(0, 5000))+
  labs(x = "", y = "Gene count") +
  theme(legend.position = "none", axis.text.x = element_blank())
p_right_ids = plt_tbl_enrichemnts %>% group_by(id_count_cat) %>% summarise(sum_count = sum(counts)) %>% 
  ggplot(aes(x = id_count_cat, y = sum_count)) + 
  geom_col(aes(fill = id_count_cat), color = "black") +
  geom_text(aes(y = sum_count, label = sum_count), hjust = -.4, size = 4) +
  coord_flip(ylim = c(1, 5000)) +
  labs(x = "", y = "Gene count") +
  theme(legend.position = "none", axis.text.y = element_blank(), 
        axis.text.x = element_text(angle = 45, hjust = 1))
  

require(patchwork)
p_top_clusters + plot_spacer() + p_htmp + p_right_ids + 
  plot_layout(ncol = 2, nrow = 2, heights = c(1,3), widths = c(3,1))

# 
loginfo("# of genes with enrichment: ", length(unique(enrichment_tbl$gene_name)))
# extract genes with more than 1 tx and 1 cluster ----
genes_morethan1enr_tbl = enrichment_tbl %>% group_by(gene_name, id, cluster) %>% summarise(counts = n()) %>% 
  group_by(gene_name) %>% summarise(id_count = length(unique(id)), cluster_count = length(unique(cluster))) %>% 
  dplyr::mutate(filter_flag = id_count > 1 & cluster_count > 1)

# ggplot(genes_morethan1enr_tbl, aes(x = filter_flag)) +
#   geom_bar()+
#   geom_text(stat = "count", aes(y = ..count.., label = ..count..), vjust = -.5) +
#   labs(x = "Genes enriched more than 1 txs in more than 1 clusters")

enrichment_filter_tbl = enrichment_tbl %>% 
  dplyr::filter(gene_name %in% 
                  (genes_morethan1enr_tbl %>% dplyr::filter(filter_flag == T))$gene_name
                ) %>% distinct()
loginfo("# of genes with more than 1 enrichment in more than 1 clusters: ", length(unique(enrichment_filter_tbl$gene_name)))
```

### function & structure annotation
```{r gather annotations for enriched txs}
txs_to_annotate = (GENE.INFO %>% dplyr::filter(`Gene name` %in% enrichment_filter_tbl$gene_name))$`Transcript name` %>% unique()
# remove noncoding txs
txs_to_annotate_CD = (GENE.INFO[match(txs_to_annotate, GENE.INFO$`Transcript name`), ] %>% dplyr::filter(!is.na(`Protein stable ID`)))$`Transcript name`

# functional annotation settings ----
python_dir = "/home/jason/anaconda3/bin/python"
work_dir = "/home/jason/git/01.ASinLung/03.python/ProteinFunctionPrediction/"
getseq_dir = paste0(work_dir, "ensembl_rest_client.py")
getfunc_dir = paste0(work_dir, "iprscan5_urllib3.py")
res_path = WhereAmI("01.DATA/01.ASinLung/06.function_annotation/0809/fasta/")

# annotating ----
iter01 = ".I1"
initiatePB(iter01)
step = 100
steps = c(seq(1, length(txs_to_annotate_CD), by = step), length(txs_to_annotate_CD)+1)
for(i in 2:length(steps)){
  t_txs_toannotate = txs_to_annotate_CD[steps[i-1]:(steps[i]-1)]
  t_status = mclapply(t_txs_toannotate, mc.cores = opts$cores, function(chosen_tx) {
    tryCatch({
    seq_path = paste0(res_path, chosen_tx, ".fasta")
    if(file.exists(seq_path)){
      return(T)
    }
    seq_contents = ''
    x = system2(python_dir, args = c(getseq_dir, "get_sequence", chosen_tx %>% transName2transid(), "-t", "protein"), stdout = T)
    y = x[6] %>% stringr::str_split('\"',simplify = T)
    trans_seq = y[4]
    seq_contents = paste0(seq_contents,
                         '> ' , chosen_tx, " | ", chosen_tx %>% transName2transid(), "\n",
                         trans_seq, "\n")
    # write file 
    readr::write_file(seq_contents, seq_path)
    return(T)
    }, error = function(e) return(F))
    }
    )
  if(length(t_txs_toannotate[!t_status %>% unlist]) > 0){
    warning(paste0(t_txs_toannotate[!t_status %>% unlist], collapse = ","), " extraction failed!")
  }
  processBar(iter01, i, length(steps), tail = "ETA") 
}

# After running shell commands ...
  
# annother way ---- may be refined later...
# ensembl = useMart("ensembl",dataset="hsapiens_gene_ensembl")
# retrieve_sequences = biomaRt::getBM(
#   attributes = "peptide",
#   filters = "ensembl_transcript_id",
#   values = txs_to_annotate_info$`Transcript stable ID`,
#   mart = ensembl
# )
```

```{shell interpro api batch script}
to_run="txs_to_run_part01"; cat $to_run | while read file ; do /home/jason/git/01.ASinLung/03.python/ProteinFunctionPrediction/iprscan5_urllib3.py --outfile=/home/jason/Storage/SYNC2/01.DATA/01.ASinLung/06.function_annotation/0802/tsv/${file} --outformat=tsv --email=lijxug@126.com --goterms --pathways --quiet /home/jason/Storage/SYNC2/01.DATA/01.ASinLung/06.function_annotation/0802/fasta/${file} || echo $file >> ${to_run}.errlog ; done; serverChan -t "protein_annotations_complete!"
```

```{r loading realted informations}
# for transcript structure
STRUCT.INFO = read_tsv(WhereAmI("01.DATA/01.ASinLung/01.raw/GRCh38.p12.biomart.transcripts.structure.txt"))
STRUCT.INFO = STRUCT.INFO %>% dplyr::mutate(`Transcript name` = GENE.INFO$`Transcript name`[match(`Transcript stable ID`, GENE.INFO$`Transcript stable ID`)])

local_loadDomains = function(annotation_tsvs, process = T){
  domain_info_list = list()
  iter02 = ".I2"
  initiatePB(iter02)
  for (i in 1:length(annotation_tsvs)) {
    tmp_file = annotation_tsvs[i]
    trans_name = tmp_file %>% stringr::str_replace(".*//(.*)\\.fasta.*", replacement = "\\1")
    if(file.exists(tmp_file)){
      trans_info = suppressMessages(suppressWarnings(read_tsv(
      tmp_file, col_names = F, progress = F
      )))
      if (nrow(trans_info)){
        trans_info = trans_info[, 1:10] # discard columnes out of 10
        colnames(trans_info)[1:10] = c(
        "Transcript name", "unknown01", "total_length", "database", "item", "description", "begin", "end", "unknown02", "unknown03"
        )
        domain_info_list[[trans_name]] = trans_info
      }
    } else { 
      domain_info_list[[trans_name]] = NULL
    }
    if(process)
      processBar(iter02, i, length(annotation_tsvs), tail = "ETA")
  }
  
  if(length(domain_info_list)){
    # combine tbl for chosen genes
    domain_info_tbl = do.call(rbind, domain_info_list) %>% as_tibble()
    # tidy df and adjust it to fit data structure for 
    domain_info_tbl = domain_info_tbl %>% dplyr::select(-matches("unknown")) %>%
    dplyr::mutate(length = end - begin, order = as.integer(as.factor(`Transcript name`)))
    return(domain_info_tbl) 
  } else{
    warning("local_loaddomains: nothing has been loaded!")
    return(tibble())
  }
}
```

```{r function/structure feature annotate}
tsv_path = WhereAmI("01.DATA/01.ASinLung/06.function_annotation/0809/tsv/")
tsv_files = Sys.glob(paste0(tsv_path, "*tsv*"))
all_domain_info_tbl = local_loadDomains(tsv_files)

# original detail tibble 
txs_detail_tbl = GENE.INFO[match(txs_to_annotate, GENE.INFO$`Transcript name`), ]

# transcript structure annotation ----
exons_tbl = STRUCT.INFO %>% group_by(`Transcript name`, `Transcript stable ID`) %>% summarise(exons = paste0(`Exon stable ID`, collapse = "|"))

txs_detail_tbl = txs_detail_tbl %>% 
  dplyr::mutate(
     `Exon IDs` = exons_tbl$exons[match(`Transcript name`, exons_tbl$`Transcript name`)], 
     Strand = STRUCT.INFO$Strand[match(`Transcript name`, STRUCT.INFO$`Transcript name`)]
  )

# protein structure annotation ----
# SignalP, Transmembrane, Pfam domain
signalP_tbl = all_domain_info_tbl %>% dplyr::select("Transcript name", "database", "item", "description") %>% distinct() %>% dplyr::filter(database == "SignalP_EUK")
transM_tbl = all_domain_info_tbl %>% dplyr::filter(database == "TMHMM") %>% dplyr::select("Transcript name", "database", "item", "begin", "end") %>% distinct() %>% group_by(`Transcript name`) %>% summarise(TMM_count = n())
pfam_tbl = all_domain_info_tbl %>% dplyr::filter(database == "Pfam") %>% dplyr::select("Transcript name", "database", "item", "begin", "end", "length") %>% distinct() %>% group_by(`Transcript name`) %>% summarise(pfam_domains = paste0(sort(item), collapse = "|"))
  
txs_detail_tbl = txs_detail_tbl %>% 
  dplyr::mutate(
    SignalP = signalP_tbl$item[match(`Transcript name`, signalP_tbl$`Transcript name`)],
    Transmembrane_number = transM_tbl$TMM_count[match(`Transcript name`, transM_tbl$`Transcript name`)],
    Pfam_domains = pfam_tbl$pfam_domains[match(`Transcript name`, pfam_tbl$`Transcript name`)]
  )

# fill 0 in coding Txs
is_coding_txs = txs_detail_tbl$`Protein stable ID` %>% is.na() %>% `!`
no_signalP_txs = is.na(txs_detail_tbl$SignalP)
no_TM_txs = is.na(txs_detail_tbl$Transmembrane_number)

txs_detail_tbl$SignalP[is_coding_txs & no_signalP_txs] = ""
txs_detail_tbl$Transmembrane_number[is_coding_txs & no_TM_txs] = 0

# add bioType
txs_detail_tbl = txs_detail_tbl %>% dplyr::mutate(bioType = type2bio(`Transcript type`))

# add protein seq
fasta_files = Sys.glob(paste0(res_path, "*.fasta"))
txs_names = stringr::str_extract(fasta_files, pattern = "(?<=/)\\w+-\\d{3}(?=\\.fasta)")
protein_seqs = mclapply(fasta_files, mc.cores = opts$cores, function(x){
  read_tsv(x, col_types = "c") %>% as.character()
}) %>% unlist()
names(protein_seqs) = txs_names

txs_detail_tbl = txs_detail_tbl %>% dplyr::mutate(prot_seq = protein_seqs[`Transcript name`])

# add subcellular location ----
local_determineSubcellular = function(SignalP, Transmembrane_number){
  return(if_else(Transmembrane_number != 0, "membrane", 
          if_else(SignalP != "" & Transmembrane_number == 0, "secreted", 
                  if_else(SignalP == "" & Transmembrane_number == 0, "cytoplasmic", "others"))))
}
txs_detail_tbl = txs_detail_tbl %>% dplyr::mutate(
  subcellular = local_determineSubcellular(SignalP, Transmembrane_number))

```

### Enrichment changing events detection
```{r change events extraction & annotation}
local_clusterSpec_txs = function(x, t_tbl){
  sapply(x, function(x){
    t_tbl$id[t_tbl$cluster == x] %>% paste0(collapse = "|")
  })
}

local_expand = function(.tbl){
  # hard coded col_name
  col_name1 = "C1_Tx1"
  col_name2 = "C2_Tx2"
  t_repeatedTx_lst1 = .tbl[[col_name1]] %>% strsplit(split = "|", fixed = T)
  t_repeatedTx_lst2 = .tbl[[col_name2]] %>% strsplit(split = "|", fixed = T)
  
  res_tbl = tibble()
  for(k in 1:nrow(.tbl)){
    single_row = .tbl[k, ]
    t_tx1 = t_repeatedTx_lst1[[k]] %>% sort()
    t_tx2 = t_repeatedTx_lst2[[k]] %>% sort()
    common_txs = intersect(t_tx1, t_tx2)
    spec_tx1 = setdiff(t_tx1, t_tx2)
    spec_tx2 = setdiff(t_tx2, t_tx1)
    
    t_col1 = rep(spec_tx1, each = length(t_tx2))
    t_col2 = rep(t_tx2, times = length(spec_tx1))
    t_col2 = c(t_col2, rep(spec_tx2, each = length(t_tx1)))
    t_col1 = c(t_col1, rep(t_tx1, times = length(spec_tx2)))
    t_df = data.frame(t_col1, t_col2, stringsAsFactors = F) %>% distinct()
    dup_single_row = single_row[rep(1, nrow(t_df)), ]
    dup_single_row[[col_name1]] = t_df[,1]
    dup_single_row[[col_name2]] = t_df[,2]
    res_tbl = bind_rows(res_tbl, dup_single_row)
  }
  
  return(res_tbl)
}
# extract change events gene by gene
enrichment_event_tbl = tibble()
chosen_genes = enrichment_filter_tbl$gene_name %>% unique()
initiatePB(iter01)
for(i in 1:length(chosen_genes)){
  chosen_gene = chosen_genes[i]
  t_tbl = enrichment_filter_tbl %>% dplyr::filter(gene_name == chosen_gene)
  clusters = t_tbl$cluster %>% unique() %>% sort()
  
  # recombination 
  cluster_pairs = combn(clusters, 2) %>% t() 
  colnames(cluster_pairs) = c("Cluster1", "Cluster2")
  t_reformat_enrichment_tbl = as_tibble(cluster_pairs)
  t_reformat_enrichment_tbl = t_reformat_enrichment_tbl %>% dplyr::mutate(
    gene_name = t_tbl$gene_name[1],
    C1_Tx1 = local_clusterSpec_txs(Cluster1, t_tbl),
    C2_Tx2 = local_clusterSpec_txs(Cluster2, t_tbl)
  ) %>% dplyr::filter(C1_Tx1 != C2_Tx2) # remove exactly same enrichment in two cluster
  
  # expand each row to make them one tx pairs at a time
  if(nrow(t_reformat_enrichment_tbl)){
    t_reformat_enrichment_tbl = local_expand(t_reformat_enrichment_tbl)
    # sum up
    enrichment_event_tbl = bind_rows(enrichment_event_tbl, t_reformat_enrichment_tbl)
  }
  
  processBar(iter01, i, length(chosen_genes), tail = "ETA")
}
rm(cluster_pairs)

# remove same enriched items
enrichment_event_tbl = enrichment_event_tbl %>% dplyr::filter(C1_Tx1 != C2_Tx2)

# annotate enrichment changing events ----
local_sortPairs = function(x, y, sep = ":"){
  stopifnot(length(x) == length(y))
  return(lapply(1:length(x), function(i){paste0(sort(c(x[i], y[i])), collapse = ":")}) %>% unlist())
}

enrichment_event_tbl = enrichment_event_tbl %>% dplyr::mutate(`Transcript pairs` = local_sortPairs(`C1_Tx1`, `C2_Tx2`))


feature_tocompare = c("Transcript type", "bioType", "Transcription start site (TSS)", "Exon IDs", "SignalP", "Transmembrane_number", "Pfam_domains", "prot_seq", "subcellular")

Tx1_details_tbl = txs_detail_tbl[match(enrichment_event_tbl$C1_Tx1, txs_detail_tbl$`Transcript name`), ] %>% 
  dplyr::select_(.dots = paste0("`", feature_tocompare, "`"))
Tx2_details_tbl = txs_detail_tbl[match(enrichment_event_tbl$C2_Tx2, txs_detail_tbl$`Transcript name`), ] %>% 
  dplyr::select_(.dots = paste0("`", feature_tocompare, "`"))

colnames(Tx1_details_tbl) = paste0("Tx1-", colnames(Tx1_details_tbl))
colnames(Tx2_details_tbl) = paste0("Tx2-", colnames(Tx2_details_tbl))

enrichment_event_ann_tbl = bind_cols(
  enrichment_event_tbl, 
  Tx1_details_tbl, Tx2_details_tbl
)

local_detectChanges = function(df, compare_var){
  quo_varNew = paste0("Change-", compare_var)
  compare_var1 = paste0("Tx1-", compare_var)
  compare_var2 = paste0("Tx2-", compare_var)
  compare_var1 = rlang::sym(compare_var1)
  compare_var2 = rlang::sym(compare_var2)
  res_data = df %>% dplyr::mutate(
     !!quo_varNew := (!!compare_var1 != !!compare_var2)
  )
  return(res_data)
}

# common procedure to compare changes (just see if they are the same)
initiatePB(iter01)
for(i in 1:length(feature_tocompare)){
  feature = feature_tocompare[i]
  enrichment_event_ann_tbl = local_detectChanges(enrichment_event_ann_tbl, feature)
  processBar(iter01, i, length(feature_tocompare))
}
enrichment_event_ann_tbl$`Gene name` = enrichment_event_ann_tbl$gene_name

# pfam domain changes detected by annother procedure 
enrichment_event_ann_tbl = enrichment_event_ann_tbl %>% dplyr::mutate(`Change-Pfam_domains_details` = as.character(`Change-Pfam_domains`))
pairs_pfmChanged_idx = enrichment_event_ann_tbl$`Change-Pfam_domains` & !is.na(enrichment_event_ann_tbl$`Change-Pfam_domains`) 

pfmChange_tbl = enrichment_event_ann_tbl[pairs_pfmChanged_idx, ] %>% dplyr::select(`Transcript pairs`, `Tx1-Pfam_domains`, `Tx2-Pfam_domains`)

pfmChanges = pfmChange_tbl %>% as.matrix() %>% apply(1, function(x){
    tx1_pfm = x[2] %>% strsplit(split = "|", fixed = T) %>% unlist() 
    tx2_pfm = x[3] %>% strsplit(split = "|", fixed = T) %>% unlist() 
    tx1_spec_pfm = setdiff(tx1_pfm, tx2_pfm) %>% paste0(collapse = "|")
    tx2_spec_pfm = setdiff(tx2_pfm, tx1_pfm) %>% paste0(collapse = "|")
    return(paste0(
      "Tx1:", tx1_spec_pfm, ";",
      "Tx2:", tx2_spec_pfm
    ))
})

enrichment_event_ann_tbl$`Change-Pfam_domains_details`[pairs_pfmChanged_idx] = pfmChanges

# change the order of column names
col_names = colnames(enrichment_event_ann_tbl)
enrichment_event_ann_tbl = enrichment_event_ann_tbl %>% dplyr::select(
  `Gene name`, `Cluster1`, `Cluster2`, `C1_Tx1`, `C2_Tx2`, `Transcript pairs`, 
  starts_with("Change"), starts_with("Tx1-"), starts_with("Tx2-")
)
events_tbl_toStore = enrichment_event_ann_tbl

# export to table ----
require(openxlsx)
wb = EXWB.initiate()
wb = EXWB.writeSheet(wb, "CD4_byClusters_allEvents", events_tbl_toStore, overwrite = T)
# openxlsx::saveWorkbook(wb, file = paste0(WhereAmI("01.DATA/01.ASinLung/04.tables/"), "CD4_byClusters_allEvents_",format(x = Sys.time(), "%m%d"), ".xlsx"), overwrite = T)

# clear trash ----
rm(Tx1_details_tbl, Tx2_details_tbl, pfmChange_tbl, pfmChanges, events_tbl_toStore)
invisible(gc())
```

```{r additional feature}
# event types ----
enrichment_event_ann_tbl = enrichment_event_ann_tbl %>% 
  dplyr::mutate(
    involved_MIX = grepl(`Transcript pairs`, pattern = "MIX"), 
    involved_txs = grepl(`Transcript pairs`, pattern = "-\\d{3}")
  )
enrichment_event_ann_txs2txs_tbl = enrichment_event_ann_tbl %>% dplyr::filter(!involved_MIX)
# gene level features ----
# generally expressed genes across clusters
# enrichment_event_ann_tbl = enrichment_event_ann_tbl %>% 
#   dplyr::mutate(
#     generally_expressed = `Gene name` %in% generally_expressed_genes
#   )

# check: protein seq not changed ----

enrichment_event_ann_txs2txs_tbl = enrichment_event_ann_txs2txs_tbl %>% 
  dplyr::mutate(
    `Tx1-prot_seq` = protein_seqs[match(C1_Tx1, names(protein_seqs))],
    `Tx2-prot_seq` = protein_seqs[match(C2_Tx2, names(protein_seqs))],
    `Change-prot_seq` = (`Tx1-prot_seq` != `Tx2-prot_seq`)
)

```

```{r general category description, fig.height=6, fig.width=8}
library(venneuler)
library(yyplot)
require(ggforce)
require(UpSetR)

# classify by whether involved `MIX` `NO_EXPR` 
ggvenn = function(x, alpha = 0.5, text_size = 16, ...) {
  ## the venneuler depends on rJava
  ## maybe wrapping VennDiagram (output gList) as geom layer
  venneuler <- rvcheck::get_fun_from_pkg("venneuler", "venneuler") ## for easy installation, as many users have issue of rJava installation
  y <- venneuler(x)
  d <- data.frame(y$centers,
                  diameters = y$diameters,
                  labels = y$labels,
                  stringsAsFactors = FALSE)
  if(is.null(text_size)){
    ggplot(d) +
      geom_circle(aes_(x0 = ~x, y0 = ~y,
                       r = ~diameters/2, fill = ~labels),
                  alpha = alpha, ...) +
      coord_fixed()
  } else {
    ggplot(d) +
      geom_circle(aes_(x0 = ~x, y0 = ~y,
                       r = ~diameters/2, fill = ~labels),
                  alpha = alpha, ...) + 
      geom_text(aes_(x = ~x, y = ~y, label = ~labels), size = text_size) + 
      coord_fixed()
  }
}
event_class_lst = list(
  MIX_involved = (1:nrow(enrichment_event_ann_tbl))[enrichment_event_ann_tbl$involved_MIX],
  Tx_involved = (1:nrow(enrichment_event_ann_tbl))[enrichment_event_ann_tbl$involved_txs]
)

event_class_df = fromList(event_class_lst)
my_cols = gg_color_hue(2)
names(my_cols) = (event_class_df %>% colnames())[c(2,1)]
p_venn = ggvenn(event_class_df, color = NA, text_size = NULL)
p_venn + 
  scale_fill_manual(values = my_cols, breaks = c("Tx_involved", "MIX_involved")) + 
  theme_void() + theme(legend.position = "none")
upset(event_class_df, order.by = "freq", sets.bar.color = my_cols, text.scale = 1.5)

```

```{r gene level category}
# gene_level_lst = list(
#   Isoform_differentially_used_genes = enrichment_event_ann_tbl$`Gene name` %>% unique(),
#   generally_expressed_genes = generally_expressed_genes)
# upset(fromList(gene_level_lst), text.scale = 1.5)
# 
# enr_generally_genes = enrichment_event_ann_tbl$`Gene name`[enrichment_event_ann_tbl$`Gene name` %in% generally_expressed_genes] %>% unique()
# enr_generally_genes
```


```{r background txs change events}
# summation for all txs pairs ----
# all_expr_txs_tbl = tibble(id = rownames(exprMat), `Gene name` = trans2gene(rownames(exprMat)))
# all_expr_txs_tbl = all_expr_txs_tbl %>% dplyr::mutate(bioType = pGenes$bioType_tx[match(id, pGenes$transcript_name)]) %>% dplyr::filter(bioType == "protein_coding")
# gene_names = (all_expr_txs_tbl %>% group_by(`Gene name`) %>% summarise(counts = n()) %>% dplyr::filter(counts > 2))$`Gene name`
# all_expr_txs_tbl = all_expr_txs_tbl %>% dplyr::filter(`Gene name` %in% gene_names)
# gene_names = all_expr_txs_tbl$`Gene name` %>% unique()
# 
# all_coding_txs_pairs_tbl = tibble()
# initiatePB(iter01)
# for(i in 1:length(gene_names)){
#   gene_name = gene_names[i]
#   t_tbl = all_expr_txs_tbl %>% dplyr::filter(`Gene name` == gene_name)
#   t_txs = t_tbl$id
#   t_txs_pairs = combn(t_txs,2) %>% t() 
#   colnames(t_txs_pairs) = c("T1", "T2")
#   t_pairs_tbl = bind_cols(as_tibble(t_txs_pairs), `Gene name` = t_txs_pairs[,"T1"] %>% trans2gene()) %>% dplyr::arrange(T1)
#   all_coding_txs_pairs_tbl = bind_rows(all_coding_txs_pairs_tbl, t_pairs_tbl)
#   processBar(iter01, i, length(gene_names), tail = "ETA")
# }
```


```{r biotype changes}
require("ggalluvial")
biotype_changes_tbl = enrichment_event_ann_txs2txs_tbl %>% group_by(`Change-bioType`, `Tx1-bioType`, `Tx2-bioType`) %>% summarise(counts = n())
ggplot(data = biotype_changes_tbl, aes(axis1 = `Tx1-bioType`, axis2 = `Tx2-bioType`, y = counts)) +
  geom_alluvium(aes(fill = `Change-bioType`)) +
  geom_stratum() + geom_text(stat = "stratum", label.strata = TRUE) +
  scale_x_discrete(limits = c("biotype of isoform 1", "biotype of isoform 2"), expand = c(.1, .05)) +
  theme(legend.position = "top")

ids = 1:nrow(enrichment_event_ann_txs2txs_tbl)
biotype_changes_lst = list(
  `Isoform1-coding` = ids[enrichment_event_ann_txs2txs_tbl$`Tx1-bioType` == "protein_coding"], 
  `Isoform1-noncoding` = ids[enrichment_event_ann_txs2txs_tbl$`Tx1-bioType` == "long_nc"],
  `Isoform2-coding` = ids[enrichment_event_ann_txs2txs_tbl$`Tx2-bioType` == "protein_coding"],
  `Isoform2-noncoding` = ids[enrichment_event_ann_txs2txs_tbl$`Tx2-bioType` == "long_nc"] 
)
sets_bar_cols = gg_color_hue(4)[c(2,4)] %>% rep(each = 2)
main_bar_cols = gg_color_hue(2)[c(1,2,2,1,NA,NA,NA)]

upset(fromList(biotype_changes_lst), text.scale = 2, 
      sets = names(biotype_changes_lst), keep.order = T, order.by = "freq", 
      sets.bar.color = sets_bar_cols, main.bar.color = main_bar_cols)

# export to table ----
wb = EXWB.writeSheet(wb, "biotypeChangingEvents",
                     enrichment_event_ann_txs2txs_tbl %>% dplyr::filter(`Change-bioType`), overwrite = T)
```

#### Describe events by the changes
```{r potential functional changes}
require(ggrepel)
require(ggforce)

# potential functional impact of all changes between coding isforms ----
enr_coding_events_tbl = enrichment_event_ann_txs2txs_tbl %>% dplyr::filter(`Tx1-bioType` == "protein_coding" & `Tx2-bioType` == "protein_coding") 

prot_seq_change_events_tbl = enr_coding_events_tbl %>% dplyr::filter(`Change-prot_seq`)


# create a vennpie ----
local_addpositionForpie = function(x,  arc_start = 0, arc_end = 2 * pi){
  require(dplyr)
  x = x %>% dplyr::mutate(
    end = (arc_end - arc_start)*cumsum(amount)/sum(amount) + arc_start)
  starts = lag(x$end, default = arc_start)
  x = x %>% dplyr::mutate(
    start = starts
  )
  return(x)
}

prot_seq_pie_tbl = tibble(
  item = c("Same protein", "Different protein"), 
  amount = c(sum(!enr_coding_events_tbl$`Change-prot_seq`, na.rm = T), sum(enr_coding_events_tbl$`Change-prot_seq`, na.rm = T)),
  r0 = 0,
  r = 1
)
prot_seq_pie_tbl = local_addpositionForpie(prot_seq_pie_tbl)

TSS_pie_tbl = tibble(
  item = c("Same TSS", "Different TSS"),
  amount = c(sum(!(enr_coding_events_tbl %>% dplyr::filter(!`Change-prot_seq`))$`Change-Transcription start site (TSS)`), sum((enr_coding_events_tbl %>% dplyr::filter(!`Change-prot_seq`))$`Change-Transcription start site (TSS)`)), 
  r0 = 1, 
  r = 1.5
)

TSS_pie_tbl = local_addpositionForpie(
  TSS_pie_tbl, 
  arc_start = prot_seq_pie_tbl$start[with(prot_seq_pie_tbl, item == "Same protein")],
  arc_end = prot_seq_pie_tbl$end[with(prot_seq_pie_tbl, item == "Same protein")]
)
total_pie_tbl = bind_rows(prot_seq_pie_tbl, TSS_pie_tbl)


subcellular_pie_tbl = tibble(
  item = c("Subcellular location changed", "Subcellular location unchanged"),
  amount = c(sum(prot_seq_change_events_tbl$`Change-subcellular`), sum(!prot_seq_change_events_tbl$`Change-subcellular`)), 
  r0 = 1.5, 
  r = 2
)
subcellular_pie_tbl = local_addpositionForpie(
  subcellular_pie_tbl, 
  arc_start = prot_seq_pie_tbl$start[with(prot_seq_pie_tbl, item == "Different protein")],
  arc_end = prot_seq_pie_tbl$end[with(prot_seq_pie_tbl, item == "Different protein")]
)
total_pie_tbl = bind_rows(total_pie_tbl, subcellular_pie_tbl)

domain_pie_tbl = tibble(
  item = c("Lack domain infos", "Domain changed", "Domain unchanged"),
  amount = c(
    sum(is.na((prot_seq_change_events_tbl %>% dplyr::filter(`Change-subcellular`))$`Change-Pfam_domains`)), 
    sum((prot_seq_change_events_tbl %>% dplyr::filter(`Change-subcellular`))$`Change-Pfam_domains`, na.rm = T), 
    sum(!(prot_seq_change_events_tbl %>% dplyr::filter(`Change-subcellular`))$`Change-Pfam_domains`, na.rm = T)), 
  r0 = 2, 
  r = 2.5
)
domain_pie_tbl = local_addpositionForpie(
  domain_pie_tbl,
  arc_start = total_pie_tbl$start[with(total_pie_tbl, item == "Subcellular location changed")],
  arc_end = total_pie_tbl$end[with(total_pie_tbl, item == "Subcellular location changed")]
)
total_pie_tbl = bind_rows(total_pie_tbl, domain_pie_tbl)

domain_pie_tbl = tibble(
  item = c("Lack domain infos", "Domain changed", "Domain unchanged"),
  amount = c(
    sum(is.na((prot_seq_change_events_tbl %>% dplyr::filter(!`Change-subcellular`))$`Change-Pfam_domains`)), 
    sum((prot_seq_change_events_tbl %>% dplyr::filter(!`Change-subcellular`))$`Change-Pfam_domains`, na.rm = T), 
    sum(!(prot_seq_change_events_tbl %>% dplyr::filter(!`Change-subcellular`))$`Change-Pfam_domains`, na.rm = T)), 
  r0 = 2, 
  r = 2.5
)
domain_pie_tbl = local_addpositionForpie(
  domain_pie_tbl,
  arc_start = total_pie_tbl$start[with(total_pie_tbl, item == "Subcellular location unchanged")],
  arc_end = total_pie_tbl$end[with(total_pie_tbl, item == "Subcellular location unchanged")]
)
total_pie_tbl = bind_rows(total_pie_tbl, domain_pie_tbl)

# detailed legend 
total_pie_tbl$item = factor(
  total_pie_tbl$item,
  levels = c(
    "Protein:", 
    total_pie_tbl$item %>% grep(pattern = "protein", value = T),
    "TSS:",
    total_pie_tbl$item %>% grep(pattern = "TSS", value = T),
    "Subcellular:",
    total_pie_tbl$item %>% grep(pattern = "Subcellular", value = T),
    "Domain:",
    unique(total_pie_tbl$item %>% grep(pattern = "domain", ignore.case = T, value = T))
  )
)
my_cols = gg_color_hue(total_pie_tbl$item %>% unique() %>% length())

total_pie_tbl %>% dplyr::mutate(
  middle_theta = start + (end - start)/2,
  middle_raddi = r0 + (r-r0)/2,
  label_x = middle_raddi * sin(middle_theta),
  label_y = middle_raddi * cos(middle_theta), 
) %>% 
  ggplot() + coord_fixed() + theme_no_axes(base.theme = theme_bw(base_size = 18)) +
  geom_arc_bar(
    aes(x0 = 0, y0 = 0, r0 = r0, r = r,
        start = start, end = end, fill = item),
    color = "white"
  ) + 
  scale_fill_manual(
    values=c("white", my_cols[1:2], 
             "white", my_cols[3:4], 
             "white", my_cols[5:6],
             "white", my_cols[7:9]), drop=FALSE) +
  geom_text(aes(x = label_x, y = label_y, label = ifelse(amount > 5, amount, ""))) +
  theme(legend.title = element_blank()) +
  labs(title = "Classification isoform-isoform coding events")


# export to table ----
# wb = EXWB.writeSheet(wb, "SameproteinDiffTSSEvents",
#                      sheetData = enr_coding_events_tbl %>% dplyr::filter(!`Change-prot_seq` & `Change-Transcription start site (TSS)`), overwrite = T)
# wb = EXWB.writeSheet(wb, "SubcellularChangeEvents", sheetData =
#                        prot_seq_change_events_tbl %>%
#                        dplyr::filter(`Change-subcellular`),
#                      overwrite = T)
# wb = EXWB.writeSheet(wb, "DomainsChangeEvents", sheetData =
#                        prot_seq_change_events_tbl %>%
#                        dplyr::filter(`Change-Pfam_domains`),
#                      overwrite = T)
# wb = EXWB.writeSheet(wb, "Neither_sub&domains_changed", sheetData =
#                        prot_seq_change_events_tbl %>% dplyr::filter(!`Change-subcellular` & !`Change-Pfam_domains`), overwrite = T)
# openxlsx::saveWorkbook(wb, file = paste0(WhereAmI("01.DATA/01.ASinLung/04.tables/"), "CD4_byClusters_allEvents_",format(x = Sys.time(), "%m%d"), ".xlsx"), overwrite = T)
```

```{r}
prot_seq_pie_tbl = tibble(
  item = c("Same protein", "Different protein"), 
  amount = c(with(enr_coding_events_tbl, length(unique(`Gene name`[!`Change-prot_seq`]))), 
             with(enr_coding_events_tbl, length(unique(`Gene name`[`Change-prot_seq`])))),
  r0 = 0,
  r = 1
)
prot_seq_pie_tbl = local_addpositionForpie(prot_seq_pie_tbl)

TSS_pie_tbl = tibble(
  item = c("Same TSS", "Different TSS"),
  amount = c(
    with(enr_coding_events_tbl %>% dplyr::filter(!`Change-prot_seq`), length(unique(`Gene name`[!`Change-Transcription start site (TSS)`]))),
    with(enr_coding_events_tbl %>% dplyr::filter(!`Change-prot_seq`), length(unique(`Gene name`[`Change-Transcription start site (TSS)`])))),
  r0 = 1, 
  r = 1.5
)

TSS_pie_tbl = local_addpositionForpie(
  TSS_pie_tbl, 
  arc_start = prot_seq_pie_tbl$start[with(prot_seq_pie_tbl, item == "Same protein")],
  arc_end = prot_seq_pie_tbl$end[with(prot_seq_pie_tbl, item == "Same protein")]
)
total_pie_tbl = bind_rows(prot_seq_pie_tbl, TSS_pie_tbl)


subcellular_pie_tbl = tibble(
  item = c("Subcellular location changed", "Subcellular location unchanged"),
  amount = c(
    with(prot_seq_change_events_tbl, length(unique(`Gene name`[`Change-subcellular`]))),
    with(prot_seq_change_events_tbl, length(unique(`Gene name`[!`Change-subcellular`])))),
  r0 = 1.5, 
  r = 2
)
subcellular_pie_tbl = local_addpositionForpie(
  subcellular_pie_tbl, 
  arc_start = prot_seq_pie_tbl$start[with(prot_seq_pie_tbl, item == "Different protein")],
  arc_end = prot_seq_pie_tbl$end[with(prot_seq_pie_tbl, item == "Different protein")]
)
total_pie_tbl = bind_rows(total_pie_tbl, subcellular_pie_tbl)

domain_pie_tbl = tibble(
  item = c("Lack domain infos", "Domain changed", "Domain unchanged"),
  amount = c(
    with(prot_seq_change_events_tbl %>% dplyr::filter(`Change-subcellular`), length(unique(`Gene name`[is.na(`Change-Pfam_domains`)]))),
    with(prot_seq_change_events_tbl %>% dplyr::filter(`Change-subcellular`), sum(!is.na(unique(`Gene name`[`Change-Pfam_domains`])))),
    with(prot_seq_change_events_tbl %>% dplyr::filter(`Change-subcellular`), sum(!is.na(unique(`Gene name`[!`Change-Pfam_domains`]))))),
  r0 = 2, 
  r = 2.5
)
domain_pie_tbl = local_addpositionForpie(
  domain_pie_tbl,
  arc_start = total_pie_tbl$start[with(total_pie_tbl, item == "Subcellular location changed")],
  arc_end = total_pie_tbl$end[with(total_pie_tbl, item == "Subcellular location changed")]
)
total_pie_tbl = bind_rows(total_pie_tbl, domain_pie_tbl)

domain_pie_tbl = tibble(
  item = c("Lack domain infos", "Domain changed", "Domain unchanged"),
  amount = c(
    with(prot_seq_change_events_tbl %>% dplyr::filter(!`Change-subcellular`), length(unique(`Gene name`[is.na(`Change-Pfam_domains`)]))),
    with(prot_seq_change_events_tbl %>% dplyr::filter(!`Change-subcellular`), sum(!is.na(unique(`Gene name`[`Change-Pfam_domains`])))),
    with(prot_seq_change_events_tbl %>% dplyr::filter(!`Change-subcellular`), sum(!is.na(unique(`Gene name`[!`Change-Pfam_domains`]))))),
  r0 = 2, 
  r = 2.5
)
domain_pie_tbl = local_addpositionForpie(
  domain_pie_tbl,
  arc_start = total_pie_tbl$start[with(total_pie_tbl, item == "Subcellular location unchanged")],
  arc_end = total_pie_tbl$end[with(total_pie_tbl, item == "Subcellular location unchanged")]
)
total_pie_tbl = bind_rows(total_pie_tbl, domain_pie_tbl)

# detailed legend 
total_pie_tbl$item = factor(
  total_pie_tbl$item,
  levels = c(
    "Protein:", 
    total_pie_tbl$item %>% grep(pattern = "protein", value = T),
    "TSS:",
    total_pie_tbl$item %>% grep(pattern = "TSS", value = T),
    "Subcellular:",
    total_pie_tbl$item %>% grep(pattern = "Subcellular", value = T),
    "Domain:",
    unique(total_pie_tbl$item %>% grep(pattern = "domain", ignore.case = T, value = T))
  )
)
my_cols = gg_color_hue(total_pie_tbl$item %>% unique() %>% length())

total_pie_tbl %>% dplyr::mutate(
  middle_theta = start + (end - start)/2,
  middle_raddi = r0 + (r-r0)/2,
  label_x = middle_raddi * sin(middle_theta),
  label_y = middle_raddi * cos(middle_theta), 
) %>% 
  ggplot() + coord_fixed() + theme_no_axes(base.theme = theme_bw(base_size = 18)) +
  geom_arc_bar(
    aes(x0 = 0, y0 = 0, r0 = r0, r = r,
        start = start, end = end, fill = item),
    color = "white"
  ) + 
  scale_fill_manual(
    values=c("white", my_cols[1:2], 
             "white", my_cols[3:4], 
             "white", my_cols[5:6],
             "white", my_cols[7:9]), drop=FALSE) +
  geom_text(aes(x = label_x, y = label_y, label = ifelse(amount > 5, amount, ""))) +
  theme(legend.title = element_blank(), 
        title = element_text(size = 15)) +
  labs(title = "Classification isoform-isoform coding events: count by genes")
```
To relate all these events with functions, I have to link them to their potential functional changes and see if they can reveal something new in C1-C2-C3(as control) and C1-C6(as negative control) and C3-C4-C6 vs C5-C6 (to find new insights)

#### Describe change events by which clusters they expand
```{r across genes, fig.width=8, fig.height=6}
require(ggraph)
require(tidygraph)

# event counts for all  
eventCounts_byClusters_tbl = enrichment_event_ann_tbl %>% 
  dplyr::mutate(col_pairs = local_sortPairs(Cluster1, Cluster2)) %>% 
  group_by(col_pairs) %>% summarise(event_count = n()) %>% 
  tidyr::separate(col = col_pairs, c("Cluster1", "Cluster2"), sep = ":")

eventCounts_gtbl = eventCounts_byClusters_tbl %>% as_tbl_graph(directed = F)

ggraph(eventCounts_gtbl, layout = "linear", circular = T) +
  geom_edge_link(aes(label = event_count, color = event_count), angle_calc = "along", label_dodge = unit(2.5, 'mm')) +
  ggraph::scale_edge_color_gradient(low = "white", high = "red") +
  geom_node_label(aes(label = name)) + 
  theme_void() +
  coord_fixed(xlim = c(-1.5,1.5)) +
  theme(legend.position = "bottom") +
  labs(title = "# of change events between clusters")
rm(eventCounts_byClusters_tbl, eventCounts_gtbl)

# gene counts for all 
geneCounts_byClusters_tbl = enrichment_event_ann_tbl %>% 
  dplyr::mutate(col_pairs = local_sortPairs(Cluster1, Cluster2)) %>% 
  group_by(col_pairs) %>% summarise(gene_count = length(unique(`Gene name`))) %>% 
  tidyr::separate(col = col_pairs, c("Cluster1", "Cluster2"), sep = ":")

geneCounts_gtbl = geneCounts_byClusters_tbl %>% as_tbl_graph(directed = F)

ggraph(geneCounts_gtbl, layout = "linear", circular = T) +
  geom_edge_link(aes(label = gene_count, color = gene_count), angle_calc = "along", label_dodge = unit(2.5, 'mm')) +
  ggraph::scale_edge_color_gradient(low = "white", high = "red") +
  geom_node_label(aes(label = name)) + 
  theme_void() +
  coord_fixed(xlim = c(-1.5,1.5)) +
  theme(legend.position = "bottom") +
  theme(legend.position = "bottom") +
  labs(title = "# of change genes between clusters")

rm(geneCounts_byClusters_tbl, geneCounts_gtbl)

```

After seeing this whole picture, let's focus on real biological question ...

## how exactly this change events would reveal the functional differences between clusters
### cluster comparison
```{r cluster pairs comparison}
chosen_clusters = c( "CD4_C6-LAYN")
# event_changes_tbl = enrichment_event_ann_txs2txs_tbl %>%
#   dplyr::filter(Cluster1 %in% chosen_clusters , Cluster2 %in% chosen_clusters) %>%
#   dplyr::mutate(cluster_pairs = local_sortPairs(Cluster1, Cluster2)) %>%
#   dplyr::filter(cluster_pairs %in% c(paste(chosen_clusters,collapse = ":"))) %>%
#   dplyr::select(`Gene name`, Cluster1, Cluster2, C1_Tx1, C2_Tx2, `cluster_pairs`, contains("subcellular"))

event_changes_tbl = enrichment_event_ann_txs2txs_tbl %>%
  dplyr::filter(Cluster1 %in% chosen_clusters | Cluster2 %in% chosen_clusters) %>%
  dplyr::mutate(cluster_pairs = local_sortPairs(Cluster1, Cluster2)) %>%
  dplyr::filter(grepl(cluster_pairs, pattern = chosen_clusters)) %>%
  dplyr::select(`Gene name`, Cluster1, Cluster2, C1_Tx1, C2_Tx2, `cluster_pairs`, contains("subcellular"))
# sort
event_changes_tbl = event_changes_tbl %>% 
  tidyr::separate(cluster_pairs, into = c("tCluster1","tCluster2"), sep = ":", remove = F)
# t_idx = with(event_changes_tbl, Cluster1 != tCluster1)
# event_changes_reform_tbl = within(
#   event_changes_tbl,
#   {
#     t_val = C2_Tx2[t_idx]
#     C2_Tx2[t_idx] = C1_Tx1[t_idx]
#     C1_Tx1[t_idx] = t_val
#     t_val = `Tx2-subcellular`[t_idx]
#     `Tx2-subcellular`[t_idx] = `Tx1-subcellular`[t_idx]
#     `Tx1-subcellular`[t_idx] = t_val
#     
#     t_val = Cluster2[t_idx]
#     Cluster2[t_idx] = Cluster1[t_idx]
#     Cluster1[t_idx] = t_val
#     
#     rm(t_val, tCluster1, tCluster2)
#   })

plt_alluvium_tbl = event_changes_reform_tbl %>% 
  group_by_(.dots = paste0("`",names(event_changes_reform_tbl)[matches("subcellular", vars = names(event_changes_reform_tbl))], "`")) %>% 
  summarise(counts = n())

# chosen_enrichments_tbl = 
#   enrichment_filter_tbl %>% dplyr::filter(cluster %in% chosen_clusters, id %in% chosen_txs)
# chosen_enrichments_tbl = bind_cols(
#   chosen_enrichments_tbl,
#   txs_detail_tbl[match(chosen_enrichments_tbl$id, txs_detail_tbl$`Transcript name`), "subcellular"]) %>% 
#   dplyr::mutate(isMIX = grepl(id, pattern = "MIX"))
# chosen_enrichments_tbl = bind_cols(
#   chosen_enrichments_tbl,
#   txs_detail_tbl[match(chosen_enrichments_tbl$id, txs_detail_tbl$`Transcript name`), c(
#     "Gene type", "Transcript type", "Transcription start site (TSS)", "APPRIS annotation", "SignalP","Transmembrane_number","Pfam_domains","bioType","prot_seq"
#   )]) %>% dplyr::mutate(
#     isMIX = grepl(id, pattern = "MIX")
#   )

# chosen_enrichments_counts_tbl = chosen_enrichments_tbl %>% 
#   group_by(cluster, isMIX) %>% summarise(freq = n()) %>% ungroup()
# chosen_enrichments_counts_tbl = chosen_enrichments_counts_tbl %>% dplyr::mutate(cohort = rownames(chosen_enrichments_counts_tbl))

ggplot(plt_alluvium_tbl,
       aes(axis1 = `Tx1-subcellular`, axis2 = `Tx2-subcellular`,
           y = counts)) +
  geom_alluvium(aes(fill = `Change-subcellular`)) +
  geom_stratum() +
  geom_label(stat = "stratum", label.strata = TRUE) +
  scale_x_discrete(limits = c("others", chosen_clusters), expand = c(.1, .05)) +
  theme(legend.position = "bottom")
  

```


<!-- construction site --> 
--- inspector for each chosen genes
### Define plotting function
```{r plot function}
# plot protein domains ----
draw_mainChain <- function(data = data,
                           size = 0.5,
                           label_size = 4,
                           margin = 0.1,
                           ...) {
  labels = unique(data$entryName)[order(unique(data$order))]
  p <- ggplot2::ggplot(data = data) + 
    ggplot2::geom_rect(mapping=ggplot2::aes(xmin=1,
                                            xmax=total_length, 
                                            ymin=order-margin, 
                                            ymax=order+margin), 
                       ...) +
    ggplot2::scale_y_continuous(breaks = 1:length(labels), 
                                labels = labels)
  
  p <- p + ggplot2::labs(x = "Amino acid number") # label x-axis
  p <- p + ggplot2::labs(y = "") # label y-axis
  
  p <- p +
    ggplot2::theme(
      axis.line.y = element_blank(),
      axis.ticks.y = element_blank())
  
  return(p)
}
draw_substructure <- function(p,
                         data = data,
                         label_size = 4, 
                         margin = .1,
                         ...){
  begin=end=description=NULL
  p <- p + ggplot2::geom_rect(data= data[data$type == "substructure",],
                              mapping=ggplot2::aes(xmin=begin,
                                                   xmax=end,
                                                   ymin=order-margin,
                                                   ymax=order+margin,
                                                   fill=item), ...)
  return(p)
}
draw_domains <- function(p,
                        data = data,
                        label_domains = TRUE,
                        label_size = 4, 
                        margin = .25,
                        ...){
    begin=end=description=NULL
    p <- p + ggplot2::geom_rect(data= data[data$type == "DOMAIN",],
            mapping=ggplot2::aes(xmin=begin,
                        xmax=end,
                        ymin=order-margin,
                        ymax=order+margin,
                        fill=description), ...)

    if(label_domains == TRUE){
        p <- p + ggplot2::geom_label(data = data[data$type == "DOMAIN", ],
                        ggplot2::aes(x = begin + (end-begin)/2,
                            y = order,
                            label = description),
                            size = label_size)
    }
    return(p)
}

# a wrapper for simple plots of txs 
local_drawProteinStructure = function(t_domain_info_tbl){
  # hard coded plotting
  if(!nrow(t_domain_info_tbl)){
    return(ggplot())
  }
  # data preparation
  t_domain_info_tbl_pfam = t_domain_info_tbl %>% dplyr::filter(database %in% c("Pfam", "TMHMM", "SignalP_EUK")) %>%
    dplyr::mutate(type = ifelse(database == "Pfam", "DOMAIN", "substructure"))
  
  # make plot
  p = draw_mainChain(t_domain_info_tbl_pfam, fill = "grey")
  p = draw_substructure(p, t_domain_info_tbl_pfam)
  p = draw_domains(p, t_domain_info_tbl_pfam, label_domains = F, color = "white", alpha = .8, margin = .2) + 
    theme(legend.direction = "vertical", legend.position = "bottom")
  return(p)
}

# 
local_splitExon = function(x, UTR_start, UTR_end){
  # x being a row of tbl
  breakpoints = table(sort(c(x$chunk_start, x$chunk_end, UTR_start, UTR_end)))
  middle = (names(breakpoints) %>% as.numeric() %>% sort())[2]
  common_end = which(breakpoints>1) %>% names() %>% as.numeric()
  x = x[c(1,1), ]
  x$chunk_start[2] = UTR_start
  x$chunk_end[2] = UTR_end
  x$chunk_coding_type[2] = F
  if(x$chunk_start[1] == common_end){ # row 1 has to be the longer one
    x$chunk_start[1] = middle
  } else {
    x$chunk_end[1] = middle
  }
  return(x)
}
# plot transcript structure ----
local_drawTranscriptStrucutre = function(exon_info_tbl,
                                         margin_MC = .05,
                                         margin_EXON = .1) {
  if(!nrow(exon_info_tbl)){
    return(ggplot())
  }
  
  # data preparation
  tx_coding_tbl = exon_info_tbl %>% dplyr::select(`Transcript name`, bioType) %>% distinct()
  tx_coding_type = tx_coding_tbl$bioType == "protein_coding" 
  names(tx_coding_type) = tx_coding_tbl$`Transcript name`
  exon_info_tbl = exon_info_tbl %>% dplyr::mutate(
    order = as.numeric(as.factor(`Transcript name`)), 
    tx_coding_type = as.logical(tx_coding_type[match(`Transcript name`, names(tx_coding_type))]),
    chunk_start = `Exon region start (bp)`, 
    chunk_end = `Exon region end (bp)`,
    chunk_coding_type = tx_coding_type
  )
  if(unique(exon_info_tbl$Strand) < 0) {
    labels = paste0("< ",
      unique(exon_info_tbl$`Transcript name`)[order(unique(exon_info_tbl$order))])
  } else {
    labels = paste0("> ",
      unique(exon_info_tbl$`Transcript name`)[order(unique(exon_info_tbl$order))])
  }
  
  # add existed UTR
  chunk_change_codingtype = with(exon_info_tbl, `5' UTR start` == chunk_start & `5' UTR end` == chunk_end) | with(exon_info_tbl, `3' UTR start` == chunk_start & `3' UTR end` == chunk_end)
  exon_info_tbl$chunk_coding_type[chunk_change_codingtype] = F
  # modification for chunk plots
  t_UTR_ridx = (!is.na(exon_info_tbl$`5' UTR start`)) | (!is.na(exon_info_tbl$`3' UTR start`))
  UTR_info_tbl = exon_info_tbl[t_UTR_ridx, ] # extract every row that UTRs are not NA
  
  # split exon ----
  t_UTR_rec_tbl = tibble()
  for(i in 1:nrow(UTR_info_tbl)){
    t_UTR_info_row = UTR_info_tbl[i, ]
    
    
    # if 5' exists
    if(!is.na(t_UTR_info_row$`5' UTR end`)){
      UTR_start = t_UTR_info_row$`5' UTR start`
      UTR_end = t_UTR_info_row$`5' UTR end`
      if(!((t_UTR_info_row$chunk_end - t_UTR_info_row$chunk_start) == (UTR_end - UTR_start))){
        t_UTR_info_row = local_splitExon(t_UTR_info_row, UTR_start, UTR_end)
      }
    } 
    
    # if 3' exists
    if(!is.na(t_UTR_info_row[1, ]$`3' UTR end`)){
      UTR_start = t_UTR_info_row[1, ]$`3' UTR start`
      UTR_end = t_UTR_info_row[1, ]$`3' UTR end`
      if(!((t_UTR_info_row[1, ]$chunk_end - t_UTR_info_row[1, ]$chunk_start) == (UTR_end - UTR_start))){
        t_UTR_info_row = bind_rows(
          t_UTR_info_row[-1, ],
          local_splitExon(t_UTR_info_row[1, ], UTR_start, UTR_end)
        )
      }
    } 
    
    t_UTR_rec_tbl = bind_rows(t_UTR_rec_tbl, t_UTR_info_row)
  }
  
  exon_info_tbl = bind_rows(
    exon_info_tbl[!t_UTR_ridx, ], 
    t_UTR_rec_tbl)
  
  
  # draw main chain ----
  p <- ggplot(data = exon_info_tbl) + 
    geom_rect(aes(
      xmin = `Transcript start (bp)`,
      xmax = `Transcript end (bp)`,
      ymin = order - margin_MC,
      ymax = order + margin_MC), 
      alpha = .5, fill = "grey"
    ) + 
    scale_y_continuous(breaks = 1:length(labels), labels = labels) +
    theme_classic(base_size = 16) +
    coord_cartesian(ylim = c(.5 , length(labels) + .5)) +
    theme(axis.line.y = element_blank(), 
          axis.ticks.y = element_blank())
  
  # draw chunks ----
  coding_colors = gg_color_hue(2) %>% sort()
  p = 
    p + 
    geom_rect(aes(
      xmin = chunk_start, 
      xmax = chunk_end, 
      ymin = order - margin_EXON, 
      ymax = order + margin_EXON,
      color = tx_coding_type, 
      fill = chunk_coding_type)) +
    scale_color_manual(labels = c("non-coding", "coding"), values = coding_colors, limits = c(F, T)) + 
    scale_fill_manual(labels = c("non-coding", "coding"), values = c("white", coding_colors[2]), limits = c(F, T)) 
  p = p + theme(legend.position = "bottom", legend.direction = "vertical")
  return(p)
}

# wrapper for single gene ----
local_plotGeneInspect = function(chosen_gene, annotation_path){
  # plt for all txs in expressed clusters for this gene
  # theme_set(theme_classic(base_size = 16))
  expressed_cluster = rep(T, length(unique(pCells$characteristics..majorCluster)))
  names(expressed_cluster) = sort(unique(pCells$characteristics..majorCluster))
  chn_cells = pCells$title[pCells$characteristics..majorCluster %in% names(expressed_cluster)[expressed_cluster]]
  
  # plt1 for gene level expression ----
  p1 = ggplot(exprMat_sum_tbl %>% dplyr::filter(Gene_name == chosen_gene, cluster %in% names(expressed_cluster[expressed_cluster]) ),  
              aes(x = cluster, y = log(tpm + 1))) +
  geom_violin(aes(fill = cluster)) +
  geom_boxplot(width = 0.1, aes(color = cluster), fill = "white") +
  labs(title = chosen_gene) +
  theme(# axis.text.x = element_text(angle = 45, hjust = 1),
  axis.text.x = element_blank(),
  axis.title.x = element_blank())
  
  chn_txs = rownames(usageMat) %>% grep(paste0("^", chosen_gene, "-\\d+"), ., value = T)
  
  # enrichment Fisher View ----
  # counts matrix calculation 
  obj = local_calculate_fishers(gene_name = chosen_gene, exprMat, usageMat, pCells)
  chn_fishers = obj$fisher.p.adj
  chn_fishers = chn_fishers[c(chn_txs, rownames(chn_fishers)[(nrow(chn_fishers) -
  1):nrow(chn_fishers)]), names(expressed_cluster[expressed_cluster])]
  canonical_tx = (obj$count %>% apply(1, sum) %>% sort(decreasing = T))[1] %>% names()
  
  # p3 = obj$count[c(chn_txs, paste0(chosen_gene, c("-NO_EXPR", "-MIX"))), names(expressed_cluster)[expressed_cluster]] %>% 
  p3 = obj$count[c(chn_txs, paste0(chosen_gene, c("-MIX"))), names(expressed_cluster)[expressed_cluster]] %>% 
    melt(varnames = c("id", "cluster"), value.name = "cell_count") %>% as_tibble() %>% dplyr::group_by(cluster) %>% dplyr::mutate(cluster_sum = sum(cell_count)) %>% 
    dplyr::mutate(`ratio of cluster` = cell_count/cluster_sum) %>% 
    ggplot(aes(x = cluster, y = id)) +
    # chn_tx_clust_usage_tbl %>% ggplot(aes(x = cluster, y = id)) +
  geom_tile(aes(fill = `ratio of cluster`), color = "white") +
  geom_text(aes(label = `cell_count`)) +
  scale_fill_gradient(low = "white") +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      axis.title = element_blank()
  )
  
  p4 = chn_fishers %>% melt(varnames = c("id", "cluster"), value.name = "-log10(fisher.p.adj)") %>% 
    dplyr::filter(!grepl(id, pattern = "NO_EXPR")) %>% 
    ggplot(aes(x = cluster, y = id)) +
  geom_tile(aes(fill = `-log10(fisher.p.adj)`), color = "white") +
  geom_text(aes(label = `-log10(fisher.p.adj)`)) +
    scale_fill_gradient2(low = "white", mid = "white", high = "red", midpoint = 1, limits = c(0, 2), breaks = c(0, 1, 1.3, 2), na.value = "red") +
    theme(
      axis.text.x = element_blank(),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      axis.title = element_blank()
    )
  
  # transcript view ----
  chn_txs = enrichment_event_ann_tbl %>% dplyr::filter(`Gene name` == chosen_gene) %>% dplyr::select(matches("C[1|2]")) %>% unlist() %>% unique()
  chn_txs = base::union(chn_txs, canonical_tx)
  test_struct_tbl = STRUCT.INFO %>% dplyr::filter(`Transcript name` %in% chn_txs) %>% dplyr::mutate(bioType = type2bio(GENE.INFO$`Transcript type`[match(`Transcript name`, GENE.INFO$`Transcript name`)]))
  p6 = local_drawTranscriptStrucutre(test_struct_tbl)
  p6 = p6 + theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1))
  # protein view ----
  annotation_tsvs = paste0(annotation_path, chn_txs, ".fasta.tsv.txt")
  t_domain_info_tbl = local_loadDomains(annotation_tsvs)
  if(nrow(t_domain_info_tbl)){
    t_domain_info_tbl = t_domain_info_tbl %>% dplyr::mutate(entryName = `Transcript name`)
    p5 = local_drawProteinStructure(t_domain_info_tbl) 
    p5 = p5 + theme(legend.position = "right")
  } else{
    p5 = ggplot()
  }
  
  # plot ----
  require(patchwork)
  total = p1 + p4 + p3 + p6 + p5 + patchwork::plot_layout(ncol = 1)
  return(total)
}
# total
```


### Check single gene
```{r inspect single gene, fig.height=14, fig.width=10}
chosen_gene = "PRF1"
total = local_plotGeneInspect(chosen_gene, annotation_path = tsv_path)
total

```

### chosen genes batch outputs

```{r batch chosen gene inspector, include=FALSE}
chosen_genes = 
  c()
out_dir = WhereAmI("01.DATA/01.ASinLung/03.graphs/02.GeneInspector/CD4_chosenGs/")

err_list = c()
for(i in 1:length(chosen_genes)){
  tryCatch({
  chosen_gene = chosen_genes[i]
  total = local_plotGeneInspect(chosen_gene, annotation_path = tsv_path)
  if(any(is.na(total))) {
    next
  }
  ggsave(filename = paste0(i, ".", chosen_gene, ".png"), plot = total, device = "png", path = out_dir, width = 10, height = 14)
  loginfo(chosen_gene, " done!")
  }, error = function(e) {err_list = c(err_list, chosen_gene)})
}
print(err_list)
msgASAP(ttl = "Graphs_output_Done")

```



```{r GO plots, fig.width=10, fig.height=7}
library(enrichplot)
library(clusterProfiler)
 
ego = enrichGO(enr_generally_genes %>% XXXToEntrez(), OrgDb = "org.Hs.eg.db", ont="BP", readable=TRUE)
# goplot(ego)
# remove redundant GO terms
ego2 = clusterProfiler::simplify(ego)
barplot(ego2, showCategory=20)
cnetplot(ego2)
emapplot(ego2)
```


## isoform usage distribution
```{r}
t_idx_id = sample(1:nrow(usageMat), round(nrow(usageMat) * 0.1, 0))
t_cell = sample(1:ncol(usageMat), round(ncol(usageMat) * 0.1, 0))
usage_tbl = usageMat[t_idx_id, t_cell] %>% melt(varnames = c("tx_id", "cell_id"), value.name = "usage") %>% as_tibble() %>% dplyr::mutate(cluster = pCells$characteristics..majorCluster[match(cell_id, pCells$title)])
usage_tbl %>% dplyr::filter(usage > 0) %>% ggplot()+
  geom_density_ridges2(aes(x = usage, y = cluster, fill = cluster))
expr_tbl = exprMat[1, ] %>% 
  as.matrix() %>% t() %>% 
  melt(varnames = c("tx_id", "cell_id"), value.name = "expr") %>% as_tibble() %>% dplyr::mutate(cluster = pCells$characteristics..majorCluster[match(cell_id, pCells$title)])
expr_tbl %>% ggplot()+
  geom_density_ridges2(aes(x = log10(expr+1), y = cluster, fill = cluster))

expr_tbl = exprMat[t_idx_id, t_cell] %>% 
  melt(varnames = c("tx_id", "cell_id"), value.name = "expr") %>% as_tibble() %>% dplyr::mutate(cluster = pCells$characteristics..majorCluster[match(cell_id, pCells$title)])
expr_tbl %>% dplyr::filter(expr>0) %>% ggplot()+
  geom_density_ridges2(aes(x = log10(expr+1), y = cluster, fill = cluster))

rm(t_idx_id, t_cell, usage_tbl, expr_tbl)
invisible(gc())
```

# New gene inspector 
add "by"
```{r new plot function}
# wrapper for single gene ----
f_plotGeneInspect = function(gene_name,
                             chosen_txs = NULL,
                             by = "cluster", 
                             chosen_cats = NULL,
                             annotation_path = tsv_path, 
                             text_size = 18, 
                             return_data = F) {
  
  ## Plot expression, enrichment, raw count and transcript/protein expression
  ## 
  ## Args:
  #'  @gene_name: Target gene
  #'  @chosen_txs: Which txs should be plot
  #'  @by: "cluster" or "tissue" to plot by
  #'  @chosen_cats: Which cluster should be plot
  #'  @text_size: The size of text, default by 18.
  #'  
  #'  Returns: 
  #'  A ggplot item with combined plot for the chosen gene. 
  
  # set basic theme
  theme_set(theme_classic(base_size = text_size))
  
  if(by == "cluster") {
    expressed_cat = rep(T, length(unique(pCells$characteristics..majorCluster)))
    names(expressed_cat) = sort(unique(pCells$characteristics..majorCluster))
    obj = all_obj_lst[[gene_name]]
  } else {
    expressed_cat = rep(T, length(unique(pCells$characteristics..tissueType)))
    names(expressed_cat) = sort(unique(pCells$characteristics..tissueType))
    obj = all_obj_lst_byTissue[[gene_name]]
  }
  
  if(is.null(chosen_cats)){
    chosen_cats = names(expressed_cat[expressed_cat])
  }
    
  
  # choose only meaningful txs to plot structure
  chn_fishers = obj$fisher.p.adj
  canonical_tx = (obj$count[grep(rownames(obj$count), pattern = "NO_EXPR", invert = T, value = T), ] %>% apply(1, sum) %>% sort(decreasing = T))[1] %>% names() 
  txsForStructures = apply(obj$fisher.p.adj, 1, function(x){sum(x>1.3) > 0})
  txsForStructures = names(txsForStructures)[txsForStructures]
  txsForStructures = c(txsForStructures, canonical_tx)
  txsForStructures = txsForStructures %>% grep(pattern = "NO_EXPR|MIX", value = T, invert = T)
  # choose txs, by default use the arguments
  if(is.null(chosen_txs)){
    chn_txs = rownames(chn_fishers)[chn_fishers %>% apply(1, function(x){sum(x>1.3)}) > 0] %>% grep(pattern = "NO_EXPR", invert = T, value = T)
  } else {
    chn_txs = chosen_txs
  }
  
  # plt1 for gene level expression ----
  p1 = exprMat_sum_tbl %>% dplyr::filter(Gene_name == gene_name) %>% dplyr::filter_(.dots = paste0(by, "%in% chosen_cats")) %>% 
    ggplot(aes_string(x = by, y = "log2(tpm+1)", color = by)) +
    geom_bar(stat = "summary", fun.y = mean, fill = "white", size = 1.2) +
    geom_errorbar(stat = "summary", fun.y = mean, fun.ymin = function(x){mean(x) - sd(x)}, fun.ymax = function(x){mean(x) + sd(x)}, width = .4, size = 1.2) +
    # geom_boxplot(width = 0.1, aes_string(color = by), fill = "white") +
    labs(title = gene_name) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      legend.position = "none",
      # axis.text.x = element_blank(),
      axis.title.x = element_blank())
  
  # count View ----
  p3 = obj$count[chn_txs, chosen_cats] %>%
    melt(varnames = c("id", "category"), value.name = "cell_count") %>% as_tibble() %>% 
    dplyr::group_by(category) %>% 
    # dplyr::mutate(category_sum = sum(cell_count)) %>%
    # dplyr::mutate(`ratio of category` = cell_count / category_sum) %>%
    ggplot(aes(x = category, y = id)) +
    # chn_tx_clust_usage_tbl %>% ggplot(aes(x = cluster, y = id)) +
    geom_tile(aes(fill = `cell_count`), color = "white") +
    geom_text(aes(label = `cell_count`)) +
    scale_fill_gradient(low = "white") +
    labs(fill = "cell count") +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      axis.title = element_blank()
    )
  
  # enrichment Fisher View ----
  p4 = chn_fishers[chn_txs, chosen_cats] %>% melt(varnames = c("id", "category"), value.name = "-log10(fisher.p.adj)") %>% 
    ggplot(aes(x = category, y = id)) +
    geom_tile(aes(fill = `-log10(fisher.p.adj)`), color = "white") +
    geom_text(aes(label = `-log10(fisher.p.adj)`)) +
    # scale_fill_gradient2(low = "white", mid = "white", high = "red", midpoint = 1, limits = c(0, 2), breaks = c(0, 1, 1.3, 2), na.value = "red") +
    scale_fill_gradient(low = "white", high = "red", limits = c(0, 1.3), na.value = "red") +
    labs(fill = "-log10(q value)") +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      axis.title = element_blank()
    )
  
  # transcript view ----
  test_struct_tbl = STRUCT.INFO %>% dplyr::filter(`Transcript name` %in% txsForStructures) %>% dplyr::mutate(bioType = type2bio(GENE.INFO$`Transcript type`[match(`Transcript name`, GENE.INFO$`Transcript name`)]))
  p6 = local_drawTranscriptStrucutre(test_struct_tbl)
  p6 = p6 + theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1))
  # protein view ----
  annotation_tsvs = paste0(annotation_path, txsForStructures, ".fasta.tsv.txt")
  t_domain_info_tbl = local_loadDomains(annotation_tsvs)
  if(nrow(t_domain_info_tbl)){
    t_domain_info_tbl = t_domain_info_tbl %>% dplyr::mutate(entryName = `Transcript name`)
    p5 = local_drawProteinStructure(t_domain_info_tbl) 
    p5 = p5 + theme(legend.position = "right")
  } else{
    p5 = ggplot()
  }
  
  
  # plot ----
  require(patchwork)
  total = p1 + p3 + p4 + p6 + p5 + patchwork::plot_layout(ncol = 1)
  if(return_data){
    return(list(plot = total, count = obj$count[chn_txs, chosen_cats]))
  }
  return(total)
}
# total
```

## Separate tmp plots
```{r, fig.height=4, fig.width=12}
# specific plot for transcript splicing diagram
chn_txs = c("RUNX3-201", "RUNX3-203", "RUNX3-205")
test_struct_tbl = STRUCT.INFO %>% dplyr::filter(`Transcript name` %in% chn_txs) %>% dplyr::mutate(bioType = type2bio(GENE.INFO$`Transcript type`[match(`Transcript name`, GENE.INFO$`Transcript name`)]))
p6 = local_drawTranscriptStrucutre(test_struct_tbl)
p6 = p6 + theme(legend.position = "right", axis.text.x = element_text(angle = 45, hjust = 1))
p6

annotation_tsvs = paste0("/data1/jason/data/01.ASinLung/tmp/tsv/", chn_txs, ".fasta.tsv.txt")
t_domain_info_tbl = local_loadDomains(annotation_tsvs)
t_domain_info_tbl = t_domain_info_tbl %>% dplyr::mutate(entryName = `Transcript name`)
p5 = local_drawProteinStructure(t_domain_info_tbl) 
p5 = p5 + theme(legend.position = "right")
p5
```

## Check single gene for variable things
```{r, fig.height=14, fig.width=10}
chosen_gene = "RUNX3"
total = f_plotGeneInspect(chosen_gene, annotation_path = "/data1/jason/data/01.ASinLung/tmp/tsv")
# chosen_gene = "HAPLN3"
# total = local_plotGeneInspect(chosen_gene, annotation_path = tsv_path)
total
```



## Check mean usage changes
```{r}
chosen_gene = "HAPLN3"
t_usageMat = usageMat[grep(rownames(usageMat), pattern = paste0("^", chosen_gene, "-\\d{3}")),]
t_usageMat_tbl = t_usageMat %>% melt(varnames = c("id", "cell_id"), value.name = "usage") %>% as_tibble() %>% 
  dplyr::mutate(cluster = pCells$characteristics..majorCluster[match(cell_id, pCells$title)])

# MIX_cells = all_obj_lst[["HAPLN3"]]$cell_tags %>% grep(pattern = "MIX", value = T) %>% names()
chn_clusters = c("CD4_C1-LEF1", "CD4_C6-LAYN")
chn_id = c("HAPLN3-201", "HAPLN3-202")

t_usageMat_tbl %>% 
  # filter(id %in% chn_id) %>%
  mutate(id = ifelse(id == "HAPLN3-201", "HAPLN3-201", "Other HAPLN3 isoforms")) %>% 
  dplyr::group_by(id, cluster) %>% 
  filter(cluster %in% chn_clusters) %>%
  summarise(mean = mean(usage), n = n(), sd = sd(usage), se = sd/sqrt(n)) %>% 
  ungroup() %>% group_by(id) %>% 
  ggplot(aes(x = cluster, y = mean, fill = id))+
  geom_col(position = position_dodge()) +
  # geom_bar(stat="identity", aes(x = cluster, y = mean, fill = id), position=position_dodge()) +
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.2, position=position_dodge(.9)) +
  # geom_path(aes(group = id))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(y = "Mean usage level")

t_testres = wilcox.test(
  t_q1, t_q2
)
```



# Enrichment changing events caculation by Tissue
```{r calculation by Tissue functions}
local_calculate_fishersByTissue = function(gene_name, expression_matrix, usage_matrix, cell_info){
# cutoffs according to p02.usage2labelcounts.R
  # 
  cell_ttlcounts_per_cluster = table(cell_info$characteristics..tissueType)
  # get txs names
  chn_txs = rownames(usage_matrix) %>% grep(pattern = paste0("^", gene_name, "-\\d+"), value = T)
  if(length(chn_txs) > 1) {
    chn_usage_matrix = usage_matrix[chn_txs,]
    chn_expression_matrix = expression_matrix[chn_txs, ] 
  } else {
    chn_usage_matrix = usage_matrix[chn_txs, ] %>% as.matrix() %>% t()
    rownames(chn_usage_matrix) = chn_txs
    chn_expression_matrix = expression_matrix[chn_txs, ] %>% as.matrix() %>% t()
    rownames(chn_expression_matrix) = chn_txs
  }
  
  chn_expressedMat = chn_expression_matrix > transcript_express_cutoff
  chn_usage_matrix[!chn_expressedMat] = 0
  groups = cell_info$characteristics..tissueType[match(colnames(chn_usage_matrix), cell_info$title)]
  cell_tags = apply((chn_usage_matrix > usage_cutoff), 2, function(x){
    tx = chn_txs[x]
    if(length(tx) == 0) 
      return("") 
    else 
      return(tx)
    })
  
  chn_countsMat = ((chn_usage_matrix > usage_cutoff) / 1) %>% t() %>% rowsum(., group = groups) %>% t()
  no_express_cells = apply(!chn_expressedMat, 2, all)
  assert_that(all(cell_tags[no_express_cells] == ""))
  cell_tags[no_express_cells] = paste0(gene_name, "-NO_EXPR")
  
  no_expr_row = no_express_cells %>% tapply(., INDEX = groups, sum)
  chn_countsMat = rbind(chn_countsMat, no_expr_row)
  rownames(chn_countsMat)[nrow(chn_countsMat)] = paste0(gene_name, "-NO_EXPR")
  # mix_row = apply((chn_usage_matrix <= usage_cutoff) , 2, all) %>% tapply(., INDEX = groups, sum) - no_expr_row
  mix_row = cell_ttlcounts_per_cluster - base::colSums(chn_countsMat)
  chn_countsMat = rbind(chn_countsMat, mix_row)
  rownames(chn_countsMat)[nrow(chn_countsMat)] = paste0(gene_name, "-MIX")
  
  # calculate fisher matrix ----
  chn_fishers = -log10(counts2FISHER_p(chn_countsMat) %>% p.adjust.matrix()) %>% round(digits = 2)
  
  # identify mix type
  mix_noexprcells = apply((chn_usage_matrix <= usage_cutoff) , 2, all)
  mix_cells = mix_noexprcells & (!no_express_cells)
  if(nrow(chn_usage_matrix) > 1 ){
    mix_usage_matrix = chn_usage_matrix[, mix_cells]
  } else{
    mix_usage_matrix = chn_usage_matrix[, mix_cells] %>% as.matrix() %>% t()
  }
  invisible(assert_that(all(chn_txs == rownames(mix_usage_matrix))))
  
  if(sum(mix_cells) > 1){
    mix_types = apply(mix_usage_matrix, 2, function(x){
    # take first two txs as mix type
      first_two = x %>% sort(decreasing = T) %>% head(2) %>% names() %>% sort() %>% paste0(collapse = "|")
      return(paste0(gene_name, "-MIX:", first_two))
    }) 
  } else if(sum(mix_cells) == 1){ 
    first_two = mix_usage_matrix %>% sort(decreasing = T) %>% head(2) %>% names() %>% sort() %>% paste0(collapse = "|")
    mix_types = paste0(gene_name, "-MIX:", first_two)
  } else { # 0
    mix_types = NULL
  }
  
  cell_tags[names(mix_types)] = mix_types
  
  return(list(count = chn_countsMat, fisher.p.adj = chn_fishers, cell_tags = cell_tags))
}
```

```{r}
chosen_genes = exprMat %>% rownames() %>% trans2gene() %>% unique()

step = 100
steps = c(seq(1, length(chosen_genes), by = step), length(chosen_genes)+1)
iter01 = ".I1"
initiatePB(iter01)
all_obj_lst_byTissue = list()
for(i in 2:length(steps)){
# for(i in 1:length(chosen_genes)){
  t_chosen_genes = chosen_genes[steps[i-1]: (steps[i] -1)]
  obj_lst = mclapply(t_chosen_genes, mc.cores = opts$cores, FUN = function(chosen_gene){
  # chosen_gene = chosen_genes[i]
    obj = local_calculate_fishersByTissue(gene_name = chosen_gene, expression_matrix = exprMat, usage_matrix = usageMat, cell_info = pCells)
    return(obj)
  })
  names(obj_lst) = t_chosen_genes
  all_obj_lst_byTissue = c(all_obj_lst_byTissue, obj_lst)
  
  processBar(iter01, i, length(steps), tail = "ETA")
}
# names(all_obj_lst_byTissue) = chosen_genes
t_enrichment_byTissue = lapply(all_obj_lst_byTissue, 
                               # mc.cores = opts$cores, 
                               function(x){
  y = x$fisher.p.adj %>% melt(value.name = "enrich_score", varnames = c("id", "cluster")) %>% as_tibble(stringsAsFactors = F) %>% dplyr::filter(enrich_score > -log10(0.05)) %>% mutate_if(is.factor, as.character)
  return(y)
})

enrichment_tbl_byTissue = do.call(rbind, t_enrichment_byTissue)
enrichment_tbl_byTissue = enrichment_tbl_byTissue %>% dplyr::mutate(gene_name = trans2gene(id)) %>% dplyr::distinct() %>% 
  dplyr::filter(!grepl(id, pattern = "NO_EXPR"))

# save only enriched more than one isoform genes in more than one tissue 
loginfo("# of genes with enrichment: ", length(unique(enrichment_tbl_byTissue$gene_name)))
# extract genes with more than 1 tx and 1 cluster ----
genes_morethan1enr_tbl_byTissue = enrichment_tbl_byTissue %>% group_by(gene_name, id, cluster) %>% summarise(counts = n()) %>% 
  group_by(gene_name) %>% summarise(id_count = length(unique(id)), cluster_count = length(unique(cluster))) %>% 
  dplyr::mutate(filter_flag = id_count > 1 & cluster_count > 1)

# ggplot(genes_morethan1enr_tbl_byTissue, aes(x = filter_flag)) +
#   geom_bar()+
#   geom_text(stat = "count", aes(y = ..count.., label = ..count..), vjust = -.5) +
#   labs(x = "Genes enriched more than 1 txs in more than 1 clusters")

enrichment_filter_tbl_byTissue = enrichment_tbl_byTissue %>% 
  dplyr::filter(gene_name %in% 
                  (genes_morethan1enr_tbl_byTissue %>% dplyr::filter(filter_flag == T))$gene_name
                ) %>% distinct()
loginfo("# of genes with more than 1 enrichment in more than 1 clusters: ", length(unique(enrichment_filter_tbl_byTissue$gene_name)))


rm(list = grep(ls(), pattern = "^t_", value = T))
# save(list = c("all_obj_lst_byTissue", "enrichment_filter_tbl_byTissue"),
#      file = "/data1/jason/data/01.ASinLung/results/CD4/CD4_EnrichmentResultsByTissue.RDa")
```
to perform cross exmaination with clone-based analysis ...

# Output dataBrowser data set 
```{r}
# save(file = "/data1/jason/data/01.ASinLung/tmp/plt_data_181126.rda", list = c("pCells", "exprMat_sum_tbl", "all_obj_lst", "STRUCT.INFO", "all_obj_lst_byTissue"))
```

# exploring (xiajibashi)
```{r}
chn_txs = grep(rownames(exprMat), pattern = paste0("^", chosen_gene, "-\\d{3}"), value = T)
chn_clusters = c("CD4_C6-LAYN")
chn_cells = (pCells %>% filter(characteristics..majorCluster %in% chn_clusters))$title
exprMat[chn_txs, chn_cells] %>% melt(varnames = c("id", "cell_id"), value.name = "tpm") %>% mutate(cluster = pCells$characteristics..majorCluster[match(cell_id, pCells$title)]) %>% ggplot(aes(x = id, y = log10(tpm+1), fill = cluster)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 45, hjust = 1))


```
